# API 改进文档

本文档记录了对乐人软件API进行的安全性和功能性改进。

## 已完成的改进

### 1. Token安全性增强
- 替换了简单的Base64编码Token实现
- 实现了简单的JWT（JSON Web Token）机制
- 增加了Token签名验证，防止篡改
- 保持了原有的过期时间机制

### 2. CORS配置改进
- 限制了允许的来源域名，不再使用通配符"*"
- 添加了开发和生产环境的域名白名单
- 增加了`Access-Control-Allow-Credentials`头支持

### 3. API访问日志记录
- 实现了完整的API访问日志记录功能
- 记录用户ID、操作类型、描述、IP地址和用户代理
- 所有重要操作都会记录成功/失败状态
- 日志存储在`system_logs`表中

### 4. API调用频率限制
- 实现了基于IP地址和用户ID的速率限制
- 不同类型的API有不同的限制规则：
  - 默认：每分钟60次请求
  - 认证相关（登录/注册）：每分钟5次请求
  - 钱包操作：每分钟30次请求
  - 授权操作：每分钟20次请求
- 自动添加速率限制响应头信息
- 自动清理过期的速率限制记录

### 5. 错误信息优化
- 避免在错误信息中暴露系统内部信息
- 统一了错误消息格式
- 数据库错误不再暴露给客户端
- 提供了更友好的错误提示

### 6. 输入验证增强
- 实现了统一的输入验证函数
- 支持多种验证规则：必填、字符串、数字、邮箱、长度限制等
- 提供详细的验证错误信息
- 所有API接口都应用了增强的输入验证

## 新增功能

### 速率限制响应头
所有API响应现在包含以下头信息：
- `X-RateLimit-Limit`: 当前窗口允许的最大请求数
- `X-RateLimit-Remaining`: 剩余可用请求数
- `X-RateLimit-Reset`: 限制重置时间戳

### 日志记录
所有关键操作都会记录到`system_logs`表，包括：
- 用户登录/注册尝试
- 钱包操作（充值、扣费）
- 授权操作（创建、检查、续期、禁用）
- 所有操作的IP地址和用户代理信息

## 数据库变更

### 新增表
1. `rate_limits` - 存储速率限制记录
2. `system_logs` - 存储API访问日志（已在数据库结构中定义）

## 安全性改进

1. **Token安全**：使用JWT替代简单编码，增强防篡改能力
2. **CORS限制**：限制允许的来源域名，防止跨域攻击
3. **输入验证**：增强的输入验证防止注入攻击
4. **速率限制**：防止API滥用和DDoS攻击
5. **日志记录**：便于安全审计和异常检测

## 使用建议

1. 定期检查`system_logs`表，监控异常活动
2. 根据实际需求调整速率限制规则
3. 确保所有生产环境域名已添加到CORS白名单
4. 考虑将JWT密钥移至环境变量中以提高安全性
5. 定期清理`rate_limits`和`system_logs`表中的旧记录

## 测试

API改进后已通过完整的测试套件验证，包括：
- 基本功能测试
- 认证流程测试
- 钱包系统测试
- 授权系统测试
- 性能测试
- 错误处理测试

所有测试均已通过，API运行正常。