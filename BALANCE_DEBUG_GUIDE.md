# 余额查询问题诊断指南

## 问题描述
登录时可以正确获取到余额900，但是单独使用余额查询按钮时返回0。

## 已添加的调试功能

### 1. 服务器端调试
在 `wallet.php` 中添加了详细的调试日志：
- Token验证后的用户ID
- 数据库查询的用户信息
- 响应数据的详细信息

### 2. VBA端调试
在 `vba_final.bas` 中添加了：
- `DebugBalanceQuery()` 函数：详细的余额查询调试
- `Base64UrlDecode()` 函数：JWT Token内容分析
- `GetUserBalance()` 增强：支持调试字段解析

## 测试步骤

### 步骤1：使用新的调试函数
在VBA中运行：
```vba
DebugBalanceQuery
```

这将显示：
- 当前用户信息和全局余额
- Token内容的详细分析
- 服务器响应的完整分析
- 余额解析过程的详细步骤

### 步骤2：检查服务器响应格式
新的API响应包含调试信息：
```json
{
  "success": true,
  "balance": "900.00",
  "message": "余额查询成功",
  "debug_user_id": 16,
  "debug_balance": 900
}
```

### 步骤3：对比登录和查询的Token
登录后，VBA会自动分析Token内容，确认用户ID是否正确。

## 可能的问题原因

### 1. Token验证问题
如果Token在验证过程中出现异常，可能导致查询到错误的用户记录。

### 2. 数据库连接问题
不同请求可能使用不同的数据库连接，导致数据不一致。

### 3. 缓存问题
服务器或中间件可能缓存了旧的响应。

## 临时解决方案

如果问题持续存在，可以：

1. 使用登录时获取的余额值，避免单独调用余额查询
2. 重新登录后再进行余额查询
3. 使用 `DebugBalanceQuery()` 函数获取详细的诊断信息

## 预期结果

修复后的系统应该：
1. 登录时正确显示余额
2. 余额查询按钮返回与登录时一致的余额
3. 所有调试信息显示正确的用户ID和余额

## 联系支持

如果问题仍然存在，请提供：
1. `DebugBalanceQuery()` 的完整输出
2. 登录时的debug输出
3. 余额查询时的debug输出